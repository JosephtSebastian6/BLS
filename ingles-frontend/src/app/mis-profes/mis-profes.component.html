<div class="mis-profes-container">
  <div class="header-row">
    <div>
      <h2>Mis Profes</h2>
      <p>Gestiona profesores, asigna estudiantes y crea grupos.</p>
    </div>
    <button class="btn-gestionar" (click)="abrirModalGrupo()">Crear grupo</button>
  </div>

  <!-- Cards resumen por profesor -->
  <div class="cards-resumen" *ngIf="profesores?.length">
    <div class="card" *ngFor="let profe of profesores">
      <div class="card-header">
        <div class="avatar">{{ (profe.nombres || '?')[0] | uppercase }}</div>
        <div class="title">
          <div class="name">{{ profe.nombres }} {{ profe.apellidos }}</div>
          <div class="sub">@{{ profe.username }}</div>
        </div>

  <div style="display:flex;justify-content:flex-end;margin:.25rem 0 8px 0;">
    <button class="btn-gestionar" (click)="toggleTabla()">
      {{ showTabla ? 'Ocultar tabla' : 'Ver tabla' }}
    </button>
  </div>
      </div>
      <div class="card-stats">
        <div class="stat">
          <div class="stat-value">{{ (resumenMap[profe.username]?.grupos_creados || 0) }}</div>
          <div class="stat-label">Grupos</div>
        </div>
        <div class="divider"></div>
        <div class="stat">
          <div class="stat-value">{{ (resumenMap[profe.username]?.estudiantes_asignados || 0) }}</div>
          <div class="stat-label">Est. asignados</div>
        </div>
      </div>
      <div class="card-actions">
        <button class="btn-gestionar" style="margin-right:8px" (click)="toggleVerGrupos(profe)">
          {{ verGruposOpen[profe.username] ? 'Ocultar grupos' : 'Ver grupos' }}
        </button>
        <button class="btn-gestionar" (click)="abrirModalEstudiantes(profe)">Gestionar estudiantes</button>
      </div>

      <!-- Listado de grupos -->
      <div class="grupos-list" *ngIf="verGruposOpen[profe.username]">
        <div class="grupo-card" *ngFor="let g of (gruposMap[profe.username] || [])">
          <div class="grupo-header" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div style="display:flex;align-items:center;gap:10px">
              <div class="grupo-unidad">{{ g.unidad || g.tema }}</div>
              <span *ngIf="g.unidad" class="badge" style="background:#e9f0ff;color:#274cdb;border-radius:12px;padding:2px 8px;font-size:12px">Unidad</span>
              <span *ngIf="g.synthetic" class="badge" style="background:#fff7e6;color:#b65c00;border-radius:12px;padding:2px 8px;font-size:12px">Auto por unidad</span>
              <div class="grupo-id">#{{ g.id }}</div>
            </div>
            <button class="btn-gestionar" *ngIf="!g.synthetic" (click)="deleteGrupo(profe, g.id)">Eliminar</button>
          </div>
          <ul class="grupo-estudiantes">
            <li *ngFor="let est of g.estudiantes">
              <strong>{{ est.nombres }} {{ est.apellidos }}</strong>
              <span class="muted">@{{ est.username }}</span>
            </li>
          </ul>
        </div>
        <div class="empty" *ngIf="(gruposMap[profe.username] || []).length === 0">Sin grupos creados.</div>
      </div>
    </div>
  </div>

  <table class="tabla-profes" *ngIf="showTabla">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Apellidos</th>
        <th>Email</th>
        <th>Estudiantes Asignados</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let profe of profesores">
        <td>{{ profe.nombres }}</td>
        <td>{{ profe.apellidos }}</td>
        <td>{{ profe.email }}</td>
        <td>{{ contarEstudiantesAsignados(profe.username) }}</td>
        <td>
          <button class="btn-gestionar" (click)="abrirModalEstudiantes(profe)">
            Gestionar Estudiantes
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <!-- Modal para gestionar estudiantes del profesor -->
  <div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Gestionar Estudiantes - {{ profesorSeleccionado?.nombres }} {{ profesorSeleccionado?.apellidos }}</h3>
        <button class="btn-cerrar" (click)="cerrarModal()">&times;</button>
      </div>
      
      <div class="modal-body">
        <div class="estudiantes-lista" *ngIf="!cargandoEstudiantes; else loadingTemplate">
          <div class="estudiante-item" *ngFor="let estudiante of todosEstudiantes">
            <div class="estudiante-info">
              <span class="nombre">{{ estudiante.nombres }} {{ estudiante.apellidos }}</span>
              <span class="username">@{{ estudiante.username }}</span>
            </div>
            <button 
              class="btn-toggle"
              [class.asignado]="estaAsignado(estudiante.username)"
              [class.no-asignado]="!estaAsignado(estudiante.username)"
              (click)="toggleAsignacion(estudiante.username)"
              [disabled]="procesandoAsignacion">
              {{ estaAsignado(estudiante.username) ? 'Desasignar' : 'Asignar' }}
            </button>
          </div>
        </div>
        
        <ng-template #loadingTemplate>
          <div class="loading">Cargando estudiantes...</div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Modal Crear Grupo -->
  <div class="modal-overlay" *ngIf="mostrarModalGrupo" (click)="cerrarModalGrupo()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Crear grupo</h3>
        <button class="btn-cerrar" (click)="cerrarModalGrupo()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-grid">
          <label>
            Profesor
            <select [(ngModel)]="formGrupo.profesor_username">
              <option *ngFor="let p of profesores" [value]="p.username">{{ p.nombres }} {{ p.apellidos }} (@{{p.username}})</option>
            </select>
          </label>
          <label>
            Unidad
            <select [(ngModel)]="formGrupo.unidad_id">
              <ng-container *ngIf="(unidadesOrDefault?.length || 0) > 0; else _fallbackUnidadOpts">
                <option *ngFor="let u of unidadesOrDefault" [value]="u.id">{{ u.nombre }}</option>
              </ng-container>
              <ng-template #_fallbackUnidadOpts>
                <option [value]="101">Unidad 1 — Introducción</option>
                <option [value]="102">Unidad 2 — Vocabulario básico</option>
                <option [value]="103">Unidad 3 — Gramática I</option>
                <option [value]="104">Unidad 4 — Comprensión lectora</option>
                <option [value]="105">Unidad 5 — Conversación I</option>
                <option [value]="106">Unidad 6 — Gramática II</option>
                <option [value]="107">Unidad 7 — Listening</option>
                <option [value]="108">Unidad 8 — Writing</option>
                <option [value]="109">Unidad 9 — Vocabulario intermedio</option>
                <option [value]="110">Unidad 10 — Proyecto final</option>
              </ng-template>
            </select>
          </label>
        </div>
        <label style="display:flex;align-items:center;gap:8px;margin:8px 0 0 0;">
          <input type="checkbox" [(ngModel)]="soloEstudiantesDeUnidad" />
          <span>Mostrar solo estudiantes de la unidad seleccionada</span>
        </label>
        <div class="estudiantes-select">
          <h4>Selecciona estudiantes</h4>
          <div class="estudiantes-list">
            <label class="est-item" *ngFor="let est of estudiantesParaCrearGrupo">
              <input type="checkbox" [checked]="formGrupo.estudiantes.includes(est.username)" (change)="toggleSeleccionEstudiante(est.username)" />
              <span>{{ est.nombres }} {{ est.apellidos }} (@{{ est.username }})</span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-gestionar" [disabled]="creandoGrupo" (click)="crearGrupo()">{{ creandoGrupo ? 'Creando...' : 'Crear grupo' }}</button>
      </div>
    </div>
  </div>
</div>
