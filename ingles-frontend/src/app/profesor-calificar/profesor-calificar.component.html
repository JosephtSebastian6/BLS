<div class="dashboard-container">
  <!-- Header con gradiente -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-info">
        <h1 class="header-title">âœï¸ Calificar Estudiante</h1>
        <p class="header-subtitle">Gestiona las calificaciones individuales de tareas y quizzes</p>
        <div class="header-stats">
          <div class="stat-item">
            <span class="stat-icon">ğŸ‘¥</span>
            <span class="stat-value">{{ estudiantesAsignados.length }}</span>
            <span class="stat-label">Estudiantes</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ“š</span>
            <span class="stat-value">{{ unidades.length }}</span>
            <span class="stat-label">Unidades</span>
          </div>
          <div class="stat-item">
            <span class="stat-icon">ğŸ“Š</span>
            <span class="stat-value">{{ getTotalCalificaciones() }}</span>
            <span class="stat-label">Calificaciones</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formulario de calificaciÃ³n -->
  <div class="grading-section">
    <div class="section-header">
      <h3 class="section-title">ğŸ“ Nueva CalificaciÃ³n</h3>
      <p class="section-subtitle">Asigna calificaciones individuales por tarea o quiz</p>
    </div>
    
    <div class="grading-form">
      <div class="form-grid">
        <!-- Selector de estudiante -->
        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">ğŸ‘¤</span>
            <span class="label-text">Estudiante</span>
          </label>
          <div class="select-wrapper">
            <select 
              [(ngModel)]="form.estudiante_username" 
              (ngModelChange)="onEstudianteChange($event)"
              class="form-select"
            >
              <option *ngFor="let e of estudiantesAsignados; trackBy: trackByEstudiante" [value]="e.username">
                {{ e.nombres }} {{ e.apellidos }} (@{{ e.username }})
              </option>
            </select>
            <span class="select-icon">ğŸ“‹</span>
          </div>
        </div>

        <!-- Selector de unidad -->
        <div class="form-group">
          <label class="form-label">
            <span class="label-icon">ğŸ“š</span>
            <span class="label-text">Unidad</span>
          </label>
          <div class="select-wrapper">
            <select 
              name="unidadSimple" 
              [ngModelOptions]="{standalone: true}" 
              [(ngModel)]="form.unidad_id" 
              (ngModelChange)="onUnidadChange($event)"
              class="form-select"
            >
              <option *ngFor="let u of unidades; trackBy: trackByUnidad" [ngValue]="u.id">
                {{ u.nombre }}
              </option>
            </select>
            <span class="select-icon">ğŸ“–</span>
          </div>
        </div>

        <!-- Tipo de calificaciÃ³n -->
        <div class="form-group type-group">
          <label class="form-label">
            <span class="label-icon">ğŸ¯</span>
            <span class="label-text">Tipo de CalificaciÃ³n</span>
          </label>
          <div class="radio-group">
            <label class="radio-option" [class.active]="form.tipo === 'tarea'">
              <input type="radio" name="tipo" value="tarea" [(ngModel)]="form.tipo">
              <span class="radio-custom"></span>
              <span class="radio-icon">ğŸ“</span>
              <span class="radio-text">Tarea</span>
            </label>
            <label class="radio-option" [class.active]="form.tipo === 'quiz'">
              <input type="radio" name="tipo" value="quiz" [(ngModel)]="form.tipo">
              <span class="radio-custom"></span>
              <span class="radio-icon">ğŸ§ </span>
              <span class="radio-text">Quiz</span>
            </label>
          </div>
        </div>

        <!-- Campo condicional para tarea -->
        <div class="form-group" *ngIf="form.tipo === 'tarea'">
          <label class="form-label">
            <span class="label-icon">ğŸ“„</span>
            <span class="label-text">Nombre del Archivo</span>
          </label>
          <input 
            type="text" 
            [(ngModel)]="form.filename" 
            placeholder="ensayo.docx"
            class="form-input"
          />
        </div>

        <!-- Campo condicional para quiz -->
        <div class="form-group" *ngIf="form.tipo === 'quiz'">
          <label class="form-label">
            <span class="label-icon">ğŸ§ </span>
            <span class="label-text">Seleccionar Quiz</span>
          </label>
          <div class="select-wrapper">
            <select [(ngModel)]="form.quiz_id" class="form-select">
              <option *ngFor="let q of quizzes; trackBy: trackByQuiz" [ngValue]="q.id">
                {{ q.titulo }}
              </option>
            </select>
            <span class="select-icon">ğŸ“</span>
          </div>
        </div>

        <!-- Score -->
        <div class="form-group score-group">
          <label class="form-label">
            <span class="label-icon">ğŸ¯</span>
            <span class="label-text">PuntuaciÃ³n (0-100)</span>
          </label>
          <div class="score-input-wrapper">
            <input 
              type="number" 
              [(ngModel)]="form.score" 
              min="0" 
              max="100" 
              placeholder="85"
              class="form-input score-input"
            />
            <span class="score-suffix">/100</span>
          </div>
          <div class="score-indicator" [class]="getScoreClass(form.score)">
            {{ getScoreLabel(form.score) }}
          </div>
        </div>
      </div>

      <!-- BotÃ³n de guardar -->
      <div class="form-actions">
        <button 
          class="save-btn" 
          [disabled]="cargando || !isFormValid()" 
          (click)="guardar()"
        >
          <span class="btn-icon">{{ cargando ? 'â³' : 'ğŸ’¾' }}</span>
          <span class="btn-text">{{ cargando ? 'Guardando...' : 'Guardar CalificaciÃ³n' }}</span>
        </button>
        
        <div class="form-message" *ngIf="msg" [class]="getMessageClass(msg)">
          <span class="message-icon">{{ getMessageIcon(msg) }}</span>
          <span class="message-text">{{ msg }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Historial de calificaciones -->
  <div class="history-section">
    <div class="section-header">
      <h3 class="section-title">ğŸ“Š Historial de Calificaciones</h3>
      <p class="section-subtitle">Revisa todas las calificaciones registradas para el estudiante seleccionado</p>
    </div>

    <div class="history-grid">
      <!-- Tareas -->
      <div class="history-card">
        <div class="card-header">
          <div class="header-info">
            <span class="header-icon">ğŸ“</span>
            <h4 class="header-title">Tareas</h4>
          </div>
          <div class="header-badge">
            <span class="badge-count">{{ historial.tareas?.length || 0 }}</span>
            <span class="badge-label">registros</span>
          </div>
        </div>
        
        <div class="card-content">
          <div *ngIf="hasTareas(); else emptyTareas" class="records-list">
            <div class="record-item" *ngFor="let tarea of historial.tareas; trackBy: trackByTarea">
              <div class="record-header">
                <span class="record-unit">ğŸ“š {{ tarea.unidad_nombre || 'Unidad ' + tarea.unidad_id }}</span>
                <span class="record-score" [class]="getScoreClass(tarea.score)">
                  {{ tarea.score }}/100
                </span>
              </div>
              <div class="record-details">
                <div class="record-filename">
                  <span class="filename-icon">ğŸ“„</span>
                  <span class="filename-text" [title]="tarea.filename">{{ tarea.filename }}</span>
                </div>
                <div class="record-date">
                  <span class="date-icon">ğŸ“…</span>
                  <span class="date-text">{{ formatDate(tarea.updated_at) }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #emptyTareas>
            <div class="empty-state">
              <div class="empty-icon">ğŸ“</div>
              <p class="empty-message">No hay tareas calificadas</p>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Quizzes -->
      <div class="history-card">
        <div class="card-header">
          <div class="header-info">
            <span class="header-icon">ğŸ§ </span>
            <h4 class="header-title">Quizzes</h4>
          </div>
          <div class="header-badge">
            <span class="badge-count">{{ historial.quizzes?.length || 0 }}</span>
            <span class="badge-label">registros</span>
          </div>
        </div>
        
        <div class="card-content">
          <div *ngIf="hasQuizzes(); else emptyQuizzes" class="records-list">
            <div class="record-item" *ngFor="let quiz of historial.quizzes; trackBy: trackByQuiz">
              <div class="record-header">
                <span class="record-unit">ğŸ“š {{ quiz.unidad_nombre || 'Unidad ' + quiz.unidad_id }}</span>
                <span class="record-score" [class]="getScoreClass(quiz.score)">
                  {{ quiz.score }}/100
                </span>
              </div>
              <div class="record-details">
                <div class="record-filename">
                  <span class="filename-icon">ğŸ§ </span>
                  <span class="filename-text" [title]="quiz.quiz_titulo || quiz.quiz_id">
                    {{ quiz.quiz_titulo || 'Quiz ' + quiz.quiz_id }}
                  </span>
                </div>
                <div class="record-date">
                  <span class="date-icon">ğŸ“…</span>
                  <span class="date-text">{{ formatDate(quiz.updated_at) }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #emptyQuizzes>
            <div class="empty-state">
              <div class="empty-icon">ğŸ§ </div>
              <p class="empty-message">No hay quizzes calificados</p>
            </div>
          </ng-template>
        </div>
      </div>

      <!-- Unidades Finales -->
      <div class="history-card">
        <div class="card-header">
          <div class="header-info">
            <span class="header-icon">ğŸ¯</span>
            <h4 class="header-title">Calificaciones Finales</h4>
          </div>
          <div class="header-badge">
            <span class="badge-count">{{ historial.unidades?.length || 0 }}</span>
            <span class="badge-label">unidades</span>
          </div>
        </div>
        
        <div class="card-content">
          <div *ngIf="hasUnidades(); else emptyUnidades" class="records-list">
            <div class="record-item" *ngFor="let unidad of historial.unidades; trackBy: trackByUnidadFinal">
              <div class="record-header">
                <span class="record-unit">ğŸ“š {{ unidad.unidad_nombre || 'Unidad ' + unidad.unidad_id }}</span>
                <span class="record-score" [class]="getScoreClass(unidad.score)" *ngIf="unidad.score !== null && unidad.score !== undefined; else noScore">
                  {{ unidad.score }}/100
                </span>
                <ng-template #noScore>
                  <span class="record-score no-score">Sin nota</span>
                </ng-template>
              </div>
              <div class="record-details">
                <div class="record-approval">
                  <span class="approval-icon">{{ getApprovalIcon(unidad.aprobado) }}</span>
                  <span class="approval-text" [class]="getApprovalClass(unidad.aprobado)">
                    {{ getApprovalText(unidad.aprobado) }}
                  </span>
                </div>
                <div class="record-date">
                  <span class="date-icon">ğŸ“…</span>
                  <span class="date-text">{{ formatDate(unidad.updated_at) }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <ng-template #emptyUnidades>
            <div class="empty-state">
              <div class="empty-icon">ğŸ¯</div>
              <p class="empty-message">No hay calificaciones finales</p>
            </div>
          </ng-template>
        </div>
      </div>
    </div>
  </div>

  <!-- CalificaciÃ³n Global -->
  <div class="global-grading-section">
    <div class="section-header">
      <h3 class="section-title">ğŸ¯ CalificaciÃ³n Global de Unidad</h3>
      <p class="section-subtitle">Asigna una calificaciÃ³n final que sobrescribe las calificaciones individuales</p>
    </div>

    <div class="global-form">
      <div class="global-grid">
        <!-- Selector de unidades mÃºltiples -->
        <div class="units-selector">
          <div class="selector-header">
            <h4 class="selector-title">
              <span class="title-icon">ğŸ“š</span>
              <span class="title-text">Unidades a Calificar</span>
            </h4>
            <p class="selector-subtitle">Selecciona una o varias unidades para aplicar la calificaciÃ³n global</p>
          </div>
          
          <div class="units-list" *ngIf="hasUnidadesDisponibles(); else noUnits">
            <div 
              class="unit-option" 
              *ngFor="let unidad of unidades; trackBy: trackByUnidad"
              [class.selected]="isUnitSelected(unidad.id)"
              (click)="toggleUnit(unidad.id)"
            >
              <div class="unit-checkbox">
                <input 
                  type="checkbox" 
                  [checked]="isUnitSelected(unidad.id)"
                  (change)="toggleUnit(unidad.id)"
                  class="checkbox-input"
                />
                <span class="checkbox-custom"></span>
              </div>
              <div class="unit-info">
                <span class="unit-icon">ğŸ“–</span>
                <span class="unit-name">{{ unidad.nombre }}</span>
              </div>
            </div>
          </div>
          
          <ng-template #noUnits>
            <div class="empty-units">
              <div class="empty-icon">ğŸ“š</div>
              <p class="empty-message">No hay unidades habilitadas para este estudiante</p>
            </div>
          </ng-template>
        </div>

        <!-- Formulario de calificaciÃ³n global -->
        <div class="global-form-panel">
          <div class="form-section">
            <h4 class="form-section-title">
              <span class="title-icon">ğŸ¯</span>
              <span class="title-text">ConfiguraciÃ³n de CalificaciÃ³n</span>
            </h4>
            
            <!-- Score final -->
            <div class="form-group">
              <label class="form-label">
                <span class="label-icon">ğŸ“Š</span>
                <span class="label-text">PuntuaciÃ³n Final</span>
                <span class="label-optional">(opcional)</span>
              </label>
              <div class="score-input-wrapper">
                <input 
                  type="number" 
                  [(ngModel)]="formFinal.score" 
                  min="0" 
                  max="100" 
                  placeholder="85"
                  class="form-input score-input"
                />
                <span class="score-suffix">/100</span>
              </div>
              <p class="form-help">
                Si no asignas una puntuaciÃ³n, solo se aplicarÃ¡ el estado de aprobaciÃ³n
              </p>
              <div class="score-indicator" [class]="getScoreClass(formFinal.score)" *ngIf="formFinal.score">
                {{ getScoreLabel(formFinal.score) }}
              </div>
            </div>

            <!-- Toggle de aprobaciÃ³n -->
            <div class="form-group approval-group">
              <label class="form-label">
                <span class="label-icon">âœ…</span>
                <span class="label-text">Estado de AprobaciÃ³n</span>
              </label>
              <div class="approval-toggle">
                <label class="toggle-switch" [class.active]="formFinal.aprobado">
                  <input 
                    type="checkbox" 
                    [(ngModel)]="formFinal.aprobado"
                    class="toggle-input"
                  />
                  <span class="toggle-slider"></span>
                  <span class="toggle-label">
                    {{ formFinal.aprobado ? 'Aprobado' : 'No Aprobado' }}
                  </span>
                </label>
              </div>
              <p class="form-help">
                Marca si el estudiante aprueba o no las unidades seleccionadas
              </p>
            </div>
          </div>

          <!-- Acciones -->
          <div class="global-actions">
            <div class="action-info">
              <span class="info-icon">â„¹ï¸</span>
              <span class="info-text">
                Se aplicarÃ¡ a {{ getSelectedUnitsCount() }} unidad(es) seleccionada(s)
              </span>
            </div>
            
            <button 
              class="global-save-btn" 
              [disabled]="cargandoFinal || !canSaveGlobal()" 
              (click)="guardarFinal()"
            >
              <span class="btn-icon">{{ cargandoFinal ? 'â³' : 'ğŸ¯' }}</span>
              <span class="btn-text">{{ cargandoFinal ? 'Guardando...' : 'Guardar CalificaciÃ³n Global' }}</span>
            </button>
            
            <div class="form-message" *ngIf="msgFinal" [class]="getMessageClass(msgFinal)">
              <span class="message-icon">{{ getMessageIcon(msgFinal) }}</span>
              <span class="message-text">{{ msgFinal }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
