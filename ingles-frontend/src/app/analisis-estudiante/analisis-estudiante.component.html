<ng-container *ngIf="useStudentLayout; else plainContent">
  <app-dashboard-layout>
    <ng-container [ngTemplateOutlet]="coreContent"></ng-container>
  </app-dashboard-layout>
</ng-container>

<ng-template #plainContent>
  <ng-container [ngTemplateOutlet]="coreContent"></ng-container>
</ng-template>

<ng-template #coreContent>
  <div class="analisis-container">
    <h2 class="page-title">Análisis del Estudiante</h2>

    <!-- Selector de estudiante (solo para empresa/profesor) -->
    <div class="estudiante-selector" *ngIf="tipoUsuario === 'empresa' || tipoUsuario === 'profesor'">
      <div class="selector-header">
        <h3>Buscar por estudiante</h3>
      </div>
      <div class="selector-content">
        <select [(ngModel)]="selectedUsername" class="estudiante-select">
          <option value="">Selecciona un estudiante</option>
          <option *ngFor="let estudiante of estudiantes" [value]="estudiante.username">
            {{ estudiante.nombres }} {{ estudiante.apellidos }} ({{ estudiante.username }})
          </option>
        </select>
        <button class="btn-buscar" (click)="irAUsuario()" [disabled]="!selectedUsername">
          <span class="material-icons">search</span>
          Buscar
        </button>
      </div>
    </div>

    <!-- Barra de progreso general -->
    <div class="progreso-card">
      <div class="progreso-header">
        <span>Progreso general</span>
        <span>{{ progreso }}%</span>
      </div>
      <div class="progreso-bar">
        <div class="progreso-fill" [style.width.%]="progreso"></div>
      </div>
    </div>

    <!-- Métricas rápidas -->
    <div class="metricas-grid">
      <div class="metrica-card" *ngFor="let m of metricas">
        <div class="metrica-titulo">{{ m.titulo }}</div>
        <div class="metrica-valor">{{ m.valor }}</div>
        <div class="metrica-descripcion">{{ m.descripcion }}</div>
      </div>
    </div>

    <!-- Progreso por unidad (cards unificadas con barra coloreada y tooltip) -->
    <div class="unidades-progreso-grid" [ngClass]="{'profesor-grid': tipoUsuario === 'profesor'}">
      <div class="unidad-progreso-card" *ngFor="let unidad of unidadesProgreso; let idx = index">
        <div class="unidad-progreso-header">
          <h4>{{ unidad.nombre }}</h4>
          <span class="unidad-porcentaje">{{ unidad.progreso }}%</span>
        </div>
        <div class="unidad-progreso-bar">
          <div class="unidad-progreso-fill" [style.width.%]="unidad.progreso" [style.background]="colorFor(unidad.progreso)" [title]="tooltipFor(unidad)"></div>
        </div>
        <div class="unidad-stats">
          <div class="stat-item">
            <span class="stat-label">Tiempo</span>
            <span class="stat-value">{{ unidad.tiempo }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Promedio tareas</span>
            <span class="stat-value">{{ unidad.promedio_tareas != null ? (unidad.promedio_tareas | number:'1.0-0') + '/100' : '—' }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Tareas</span>
            <span class="stat-value">{{ unidad.tareas_count || 0 }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Score final</span>
            <span class="stat-value">{{ unidad.score_final != null ? (unidad.score_final | number:'1.0-0') + '/100' : '—' }}</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Última entrega</span>
            <span class="stat-value">{{ unidad.ultima_entrega ? (unidad.ultima_entrega | date:'short') : '—' }}</span>
          </div>
        </div>
        <div class="unidad-actions">
          <button class="btn-buscar" (click)="verTareas(idx)">Ver tareas</button>
        </div>
      </div>
    </div>
  </div>
</ng-template>
